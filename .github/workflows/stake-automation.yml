name: STAKE Leaderboard Auto Update (Apps Script Web App)

on:
  # 6ì‹œê°„ë§ˆë‹¤ ìë™ ì‹¤í–‰ (UTC ê¸°ì¤€: 00:00, 06:00, 12:00, 18:00)
  schedule:
    - cron: '0 */6 * * *'
  
  # ìˆ˜ë™ ì‹¤í–‰ ê°€ëŠ¥
  workflow_dispatch:
    inputs:
      force_update:
        description: 'Force full data update'
        required: false
        default: false
        type: boolean

# í™˜ê²½ë³€ìˆ˜ ì„¤ì •
env:
  PYTHONUNBUFFERED: 1
  TZ: Asia/Seoul

jobs:
  update-leaderboard:
    runs-on: ubuntu-latest
    timeout-minutes: 180
    permissions:
      contents: write  # JSON íŒŒì¼ ì»¤ë°‹ì„ ìœ„í•œ ê¶Œí•œ
      pages: write     # GitHub Pages ë°°í¬ ê¶Œí•œ
      id-token: write  # í† í° ê¶Œí•œ
    
    steps:
    # 1. ì½”ë“œ ì²´í¬ì•„ì›ƒ
    - name: ğŸ“‚ Checkout Repository
      uses: actions/checkout@v4
    
    # 2. Python í™˜ê²½ ì„¤ì •
    - name: ğŸ Setup Python 3.11
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        cache: 'pip'
    
    # 3. ì˜ì¡´ì„± ì„¤ì¹˜
    - name: ğŸ“¦ Install Dependencies
      run: |
        python -m pip install --upgrade pip
        if [ -f requirements.txt ]; then
          pip install -r requirements.txt
        else
          pip install requests pandas schedule python-dateutil pytz
        fi
    
    # 4. Python ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰ ì „ ì¤€ë¹„
    - name: âš™ï¸ Prepare Environment
      run: |
        echo "ğŸš€ STAKE ë¦¬ë”ë³´ë“œ ì—…ë°ì´íŠ¸ ì‹œì‘ (Apps Script Web App ì—°ë™)"
        echo "âš ï¸ ê¸°ì¡´ 21ê°œ ì»¬ëŸ¼ë§Œ ì—…ë°ì´íŠ¸ (A:U ë²”ìœ„)"
        echo "âœ… ì‹ ê·œ 18ê°œ ì»¬ëŸ¼ ë³´í˜¸ (V:AM ë²”ìœ„)"
        echo "ğŸ”— Apps Script Web Appìœ¼ë¡œ ì „ì†¡"
        echo "â° ì‹¤í–‰ ì‹œê°„: $(date)"
        echo "ğŸŒ íƒ€ì„ì¡´: $TZ"
        
        # ë°±ì—… ë””ë ‰í† ë¦¬ ìƒì„±
        mkdir -p python-scripts/backup
        
        # í™˜ê²½ë³€ìˆ˜ í™•ì¸ (ë¯¼ê°ì •ë³´ ì œì™¸)
        echo "ğŸ”— Apps Script Web App URL ì„¤ì •: ${APPS_SCRIPT_WEB_APP_URL:0:50}..."
    
    # 5. âš ï¸ ì•ˆì „ ëª¨ë“œ: Apps Script Web Appìœ¼ë¡œ ì—…ë°ì´íŠ¸
    - name: ğŸš€ Update STAKE Leaderboard (Apps Script Web App)
      env:
        APPS_SCRIPT_WEB_APP_URL: ${{ secrets.APPS_SCRIPT_WEB_APP_URL }}
        SAFE_MODE: true  # ğŸ†• ì•ˆì „ ëª¨ë“œ í™œì„±í™”
        UPDATE_RANGE: "A:U"  # ğŸ†• ì—…ë°ì´íŠ¸ ë²”ìœ„ ì œí•œ
      working-directory: python-scripts
      run: |
        echo "ğŸš€ Apps Script Web Appìœ¼ë¡œ STAKE ë°ì´í„° ì „ì†¡ ì‹œì‘..."
        echo "ğŸ“Š ì—…ë°ì´íŠ¸ ë²”ìœ„: A:U (ê¸°ì¡´ 21ê°œ ì»¬ëŸ¼ë§Œ)"
        echo "ğŸ”’ ì‹ ê·œ ì»¬ëŸ¼ ë³´í˜¸: V:AM (Apps Script ìë™ ì²˜ë¦¬)"
        echo "ğŸ”— Sheet.best ì™„ì „ ì œê±° â†’ Apps Script Web App ì—°ë™"
        
        # íƒ€ì„ì•„ì›ƒê³¼ í•¨ê»˜ Python ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰
        timeout 10800 python stake_leaderboard_system.py || {
          echo "âŒ ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰ ì‹¤íŒ¨ ë˜ëŠ” íƒ€ì„ì•„ì›ƒ"
          exit 1
        }
        
        echo "âœ… STAKE ë¦¬ë”ë³´ë“œ Apps Script Web App ì—…ë°ì´íŠ¸ ì™„ë£Œ"
    
    # 6. ë°±ì—… íŒŒì¼ ì•„í‹°íŒ©íŠ¸ë¡œ ì €ì¥
    - name: ğŸ’¾ Save Backup Files
      if: always()  # ì‹¤íŒ¨í•´ë„ ë°±ì—… íŒŒì¼ ì €ì¥
      uses: actions/upload-artifact@v4
      with:
        name: stake-leaderboard-backup-${{ github.run_number }}
        path: |
          python-scripts/backup/*.csv
          python-scripts/backup/*.json
          python-scripts/*.log
        retention-days: 30
        if-no-files-found: ignore
    
    # 7. Apps Script Web App ì‹¤í–‰ ê²°ê³¼ ìš”ì•½
    - name: ğŸ“Š Apps Script Web App Execution Summary
      if: always()
      run: |
        echo "ğŸ¯ === STAKE Apps Script Web App ì—…ë°ì´íŠ¸ ì™„ë£Œ ==="
        echo "ğŸš€ Sheet.best ì™„ì „ ì œê±° â†’ Apps Script Web App ì—°ë™"
        echo "ğŸ›¡ï¸ ë³´í˜¸ëœ ë²”ìœ„: V:AM (ì‹ ê·œ 18ê°œ ì»¬ëŸ¼)"
        echo "âœ… ì—…ë°ì´íŠ¸ëœ ë²”ìœ„: A:U (ê¸°ì¡´ 21ê°œ ì»¬ëŸ¼)"
        echo "ğŸ”— Apps Scriptì—ì„œ 39ê°œ ì»¬ëŸ¼ ì™„ì „ ì²˜ë¦¬"
        echo "ğŸ“… ì‹¤í–‰ ì‹œê°„: $(date)"
        echo "ğŸ”¢ ì‹¤í–‰ ë²ˆí˜¸: ${{ github.run_number }}"
        echo "ğŸ“‚ ë°±ì—… íŒŒì¼ ìƒì„±: python-scripts/backup/"
        echo ""
        echo "ğŸ”„ ë‹¤ìŒ ë‹¨ê³„:"
        echo "1. Apps Script Web Appì´ POST ìš”ì²­ ìˆ˜ì‹ "
        echo "2. ê¸°ì¡´ 21ê°œ ì»¬ëŸ¼ êµ¬ê¸€ì‹œíŠ¸ ì—…ë°ì´íŠ¸"
        echo "3. ì‹ ê·œ 18ê°œ ì»¬ëŸ¼ ìë™ ê³„ì‚° ë° ì¶”ê°€"
        echo "4. 39ê°œ ì»¬ëŸ¼ ì™„ì „í•œ JSON íŒŒì¼ ìƒì„±"
        echo "5. ì™„ì „í•œ STAKE ë¦¬ë”ë³´ë“œ ì‹œìŠ¤í…œ ê°€ë™"
        
        # ë°±ì—… íŒŒì¼ ëª©ë¡ ì¶œë ¥
        if [ -d "python-scripts/backup" ]; then
          echo "ğŸ“ ìƒì„±ëœ ë°±ì—… íŒŒì¼:"
          ls -la python-scripts/backup/ || echo "ë°±ì—… íŒŒì¼ ì—†ìŒ"
        fi
        
        # ë¡œê·¸ íŒŒì¼ í™•ì¸
        if [ -f "python-scripts/stake_leaderboard.log" ]; then
          echo "ğŸ“‹ ë§ˆì§€ë§‰ ë¡œê·¸ 10ì¤„:"
          tail -10 python-scripts/stake_leaderboard.log
        fi
    
    # 8. ì‹¤íŒ¨ ì‹œ ì•Œë¦¼ (ì„ íƒì‚¬í•­)
    - name: ğŸš¨ Failure Notification
      if: failure()
      run: |
        echo "ğŸ’¥ STAKE ë¦¬ë”ë³´ë“œ Apps Script Web App ì—…ë°ì´íŠ¸ ì‹¤íŒ¨!"
        echo "ğŸ” ë¡œê·¸ë¥¼ í™•ì¸í•˜ì—¬ ë¬¸ì œë¥¼ ì§„ë‹¨í•˜ì„¸ìš”."
        echo "ğŸ“§ GitHub Actions íƒ­ì—ì„œ ìƒì„¸ ë¡œê·¸ë¥¼ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤."
        echo "âš ï¸ ì‹ ê·œ 18ê°œ ì»¬ëŸ¼ì€ ì˜í–¥ë°›ì§€ ì•ŠìŠµë‹ˆë‹¤."
        echo "ğŸ”„ Apps Script Web App ì—°ë™ ë¬¸ì œì¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤."
        
        # ì—ëŸ¬ ë¡œê·¸ ì¶œë ¥
        if [ -f "python-scripts/stake_leaderboard.log" ]; then
          echo "âŒ ì—ëŸ¬ ë¡œê·¸:"
          tail -20 python-scripts/stake_leaderboard.log
        fi

# ë™ì‹œ ì‹¤í–‰ ì œí•œ (ì¤‘ë³µ ì‹¤í–‰ ë°©ì§€)
concurrency:
  group: stake-leaderboard-update-apps-script
  cancel-in-progress: false