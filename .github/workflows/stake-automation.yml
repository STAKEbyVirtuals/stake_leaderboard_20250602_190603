name: STAKE Leaderboard Auto Update

on:
  # 6ì‹œê°„ë§ˆë‹¤ ìë™ ì‹¤í–‰ (UTC ê¸°ì¤€: 00:00, 06:00, 12:00, 18:00)
  schedule:
    - cron: '0 */6 * * *'
  
  # ìˆ˜ë™ ì‹¤í–‰ ê°€ëŠ¥
  workflow_dispatch:
    inputs:
      force_update:
        description: 'Force full data update'
        required: false
        default: false
        type: boolean

# í™˜ê²½ë³€ìˆ˜ ì„¤ì •
env:
  PYTHONUNBUFFERED: 1
  TZ: Asia/Seoul

jobs:
  update-leaderboard:
    runs-on: ubuntu-latest
    timeout-minutes: 180  # 3ì‹œê°„ íƒ€ì„ì•„ì›ƒ
    
    steps:
    # 1. ì½”ë“œ ì²´í¬ì•„ì›ƒ
    - name: ğŸ“‚ Checkout Repository
      uses: actions/checkout@v4
    
    # 2. Python í™˜ê²½ ì„¤ì •
    - name: ğŸ Setup Python 3.11
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        cache: 'pip'
    
    # 3. ì˜ì¡´ì„± ì„¤ì¹˜
    - name: ğŸ“¦ Install Dependencies
      run: |
        python -m pip install --upgrade pip
        pip install requests pandas schedule
        pip install python-dateutil pytz
    
    # 4. Python ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰ ì „ ì¤€ë¹„
    - name: âš™ï¸ Prepare Environment
      run: |
        echo "ğŸš€ STAKE ë¦¬ë”ë³´ë“œ ì—…ë°ì´íŠ¸ ì‹œì‘"
        echo "â° ì‹¤í–‰ ì‹œê°„: $(date)"
        echo "ğŸŒ íƒ€ì„ì¡´: $TZ"
        
        # ë°±ì—… ë””ë ‰í† ë¦¬ ìƒì„±
        mkdir -p python-scripts/backup
        
        # í™˜ê²½ë³€ìˆ˜ í™•ì¸ (ë¯¼ê°ì •ë³´ ì œì™¸)
        echo "ğŸ”— Sheet.best URL ì„¤ì •: ${SHEET_BEST_URL:0:30}..."
    
    # 5. STAKE ë°ì´í„° ì¶”ì¶œ ë° ì—…ë¡œë“œ
    - name: ğŸ¥© Update STAKE Leaderboard
      env:
        SHEET_BEST_URL: ${{ secrets.SHEET_BEST_URL }}
      working-directory: python-scripts
      run: |
        echo "ğŸ“Š STAKE ë°ì´í„° ì¶”ì¶œ ì‹œì‘..."
        
        # íƒ€ì„ì•„ì›ƒê³¼ í•¨ê»˜ Python ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰
        timeout 10800 python stake_leaderboard_system.py || {
          echo "âŒ ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰ ì‹¤íŒ¨ ë˜ëŠ” íƒ€ì„ì•„ì›ƒ"
          exit 1
        }
        
        echo "âœ… STAKE ë¦¬ë”ë³´ë“œ ì—…ë°ì´íŠ¸ ì™„ë£Œ"
    
    # 6. ë°±ì—… íŒŒì¼ ì•„í‹°íŒ©íŠ¸ë¡œ ì €ì¥
    - name: ğŸ’¾ Save Backup Files
      if: always()  # ì‹¤íŒ¨í•´ë„ ë°±ì—… íŒŒì¼ ì €ì¥
      uses: actions/upload-artifact@v4
      with:
        name: stake-leaderboard-backup-${{ github.run_number }}
        path: |
          python-scripts/backup/*.csv
          python-scripts/backup/*.json
          python-scripts/*.log
        retention-days: 30
        if-no-files-found: ignore
    
    # 7. ì‹¤í–‰ ê²°ê³¼ ìš”ì•½
    - name: ğŸ“Š Execution Summary
      if: always()
      run: |
        echo "ğŸ¯ === STAKE ë¦¬ë”ë³´ë“œ ì—…ë°ì´íŠ¸ ì™„ë£Œ ==="
        echo "ğŸ“… ì‹¤í–‰ ì‹œê°„: $(date)"
        echo "ğŸ”¢ ì‹¤í–‰ ë²ˆí˜¸: ${{ github.run_number }}"
        echo "ğŸ“‚ ë°±ì—… íŒŒì¼ ìƒì„±: python-scripts/backup/"
        
        # ë°±ì—… íŒŒì¼ ëª©ë¡ ì¶œë ¥
        if [ -d "python-scripts/backup" ]; then
          echo "ğŸ“ ìƒì„±ëœ ë°±ì—… íŒŒì¼:"
          ls -la python-scripts/backup/ || echo "ë°±ì—… íŒŒì¼ ì—†ìŒ"
        fi
        
        # ë¡œê·¸ íŒŒì¼ í™•ì¸
        if [ -f "python-scripts/stake_leaderboard.log" ]; then
          echo "ğŸ“‹ ë§ˆì§€ë§‰ ë¡œê·¸ 10ì¤„:"
          tail -10 python-scripts/stake_leaderboard.log
        fi
    
    # 8. ì‹¤íŒ¨ ì‹œ ì•Œë¦¼ (ì„ íƒì‚¬í•­)
    - name: ğŸš¨ Failure Notification
      if: failure()
      run: |
        echo "ğŸ’¥ STAKE ë¦¬ë”ë³´ë“œ ì—…ë°ì´íŠ¸ ì‹¤íŒ¨!"
        echo "ğŸ” ë¡œê·¸ë¥¼ í™•ì¸í•˜ì—¬ ë¬¸ì œë¥¼ ì§„ë‹¨í•˜ì„¸ìš”."
        echo "ğŸ“§ GitHub Actions íƒ­ì—ì„œ ìƒì„¸ ë¡œê·¸ë¥¼ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤."
        
        # ì—ëŸ¬ ë¡œê·¸ ì¶œë ¥
        if [ -f "python-scripts/stake_leaderboard.log" ]; then
          echo "âŒ ì—ëŸ¬ ë¡œê·¸:"
          tail -20 python-scripts/stake_leaderboard.log
        fi

# ë™ì‹œ ì‹¤í–‰ ì œí•œ (ì¤‘ë³µ ì‹¤í–‰ ë°©ì§€)
concurrency:
  group: stake-leaderboard-update
  cancel-in-progress: false