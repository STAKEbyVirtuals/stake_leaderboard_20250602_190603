name: STAKE Incremental Update (10min)

on:
  # 10ë¶„ë§ˆë‹¤ ì‹¤í–‰
  schedule:
    - cron: '*/10 * * * *'
  
  # ìˆ˜ë™ ì‹¤í–‰ ê°€ëŠ¥
  workflow_dispatch:
    inputs:
      debug_mode:
        description: 'Enable debug logging'
        required: false
        default: false
        type: boolean

env:
  PYTHONUNBUFFERED: 1
  TZ: Asia/Seoul
  INCREMENTAL_MODE: true

jobs:
  incremental-update:
    runs-on: ubuntu-latest
    timeout-minutes: 10  # 10ë¶„ ì œí•œ (ì¦ë¶„ì€ ë¹ ë¦„)
    permissions:
      contents: write
      pages: write
      id-token: write
    
    steps:
    - name: ğŸ“‚ Checkout Repository
      uses: actions/checkout@v4
    
    - name: ğŸ Setup Python 3.11
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        cache: 'pip'
    
    - name: ğŸ“¦ Install Dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
    
    - name: ğŸš€ Run Incremental Update
      env:
        APPS_SCRIPT_WEB_APP_URL: ${{ secrets.APPS_SCRIPT_WEB_APP_URL }}
        SAFE_MODE: true
        UPDATE_RANGE: "A:U"
      working-directory: python-scripts
      run: |
        echo "ğŸ“ˆ ì¦ë¶„ ì—…ë°ì´íŠ¸ ì‹œì‘ (ìµœê·¼ ë¸”ë¡ë§Œ ìŠ¤ìº”)"
        echo "â° ì‹¤í–‰ ì‹œê°„: $(date)"
        
        # ì²´í¬í¬ì¸íŠ¸ íŒŒì¼ í™•ì¸
        if [ -f "checkpoint.json" ]; then
          echo "âœ… ì²´í¬í¬ì¸íŠ¸ íŒŒì¼ ë°œê²¬"
          cat checkpoint.json
        else
          echo "ğŸ†• ì²« ì‹¤í–‰ - ì²´í¬í¬ì¸íŠ¸ ìƒì„±ë¨"
        fi
        
        # ì¦ë¶„ ì—…ë°ì´íŠ¸ ì‹¤í–‰
        python stake_leaderboard_system.py --incremental
        
        echo "âœ… ì¦ë¶„ ì—…ë°ì´íŠ¸ ì™„ë£Œ"
    
    - name: ğŸ’¾ Commit Checkpoint
      if: success()
      run: |
        git config --local user.name "GitHub Actions"
        git config --local user.email "actions@github.com"
        
        # ì²´í¬í¬ì¸íŠ¸ íŒŒì¼ ì»¤ë°‹
        git add python-scripts/checkpoint.json
        git add public/leaderboard.json || true
        
        # ë³€ê²½ì‚¬í•­ì´ ìˆì„ ë•Œë§Œ ì»¤ë°‹
        git diff --staged --quiet || git commit -m "Update checkpoint - Block $(date +%s)"
        git push || echo "No changes to push"
    
    - name: ğŸ“Š Update Summary
      if: always()
      run: |
        echo "### ğŸ“ˆ ì¦ë¶„ ì—…ë°ì´íŠ¸ ì™„ë£Œ"
        echo "- ì‹¤í–‰ ì‹œê°„: $(date)"
        echo "- ëª¨ë“œ: ì¦ë¶„ (ìµœê·¼ ë¸”ë¡ë§Œ)"
        echo "- ì£¼ê¸°: 10ë¶„"
        echo ""
        if [ -f "python-scripts/checkpoint.json" ]; then
          echo "#### ì²´í¬í¬ì¸íŠ¸ ì •ë³´"
          cat python-scripts/checkpoint.json
        fi

concurrency:
  group: stake-incremental-update
  cancel-in-progress: false